<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Hidrop√≥nico - GitHub</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: linear-gradient(135deg, #667eea, #764ba2); padding: 20px; min-height: 100vh; }
        .container { max-width: 900px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 30px; padding: 20px; }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .card { background: white; padding: 25px; border-radius: 12px; margin: 15px 0; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .config-card { background: #fff3cd; border: 2px solid #ffc107; }
        .form-group { margin: 15px 0; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568; }
        .form-group input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em; }
        .login-button { width: 100%; padding: 12px; background: #4299e1; color: white; border: none; border-radius: 8px; font-size: 1.1em; font-weight: 600; cursor: pointer; margin: 10px 0; }
        .data-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 15px; margin: 20px 0; }
        .data-item { text-align: center; padding: 20px 10px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #4299e1; }
        .data-value { font-size: 1.8em; font-weight: bold; color: #2d3748; margin-bottom: 5px; }
        .data-label { color: #718096; font-size: 0.9em; }
        .button-group { display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
        .button { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; flex: 1; min-width: 120px; }
        .button.on { background: #48bb78; color: white; }
        .button.off { background: #f56565; color: white; }
        .button.auto { background: #4299e1; color: white; }
        .status { padding: 12px; border-radius: 8px; margin: 15px 0; text-align: center; font-weight: 600; }
        .online { background: #c6f6d5; color: #22543d; border: 2px solid #48bb78; }
        .offline { background: #fed7d7; color: #742a2a; border: 2px solid #f56565; }
        .info-box { background: #e6fffa; border: 2px solid #38b2ac; border-radius: 8px; padding: 15px; margin: 15px 0; }
        .error-message { background: #fed7d7; color: #742a2a; padding: 12px; border-radius: 8px; margin: 15px 0; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå± Sistema Hidrop√≥nico</h1>
            <h2>SEGUNDO F√çSICA - QU√çMICA</h2>
        </div>

        <!-- CONFIGURACI√ìN DE CONEXI√ìN -->
        <div class="card config-card">
            <h2>üîß Configurar Conexi√≥n ESP32</h2>
            <div class="form-group">
                <label for="esp32IP">IP del ESP32:</label>
                <input type="text" id="esp32IP" placeholder="Ej: 192.168.1.135" value="192.168.1.135">
            </div>
            <button class="login-button" onclick="probarConexion()">üîç Probar Conexi√≥n</button>
            <div class="status" id="configStatus">Esperando configuraci√≥n...</div>
        </div>

        <!-- LOGIN -->
        <div id="loginSection" class="card">
            <h2>üîê Iniciar Sesi√≥n</h2>
            <div class="error-message" id="errorMessage"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Usuario:</label>
                    <input type="text" id="username" placeholder="Ej: acapa, admin" required>
                </div>
                <div class="form-group">
                    <label for="password">Contrase√±a:</label>
                    <input type="password" id="password" placeholder="Ej: Acapa1!, Admin123!" required>
                </div>
                <button type="submit" class="login-button">üéØ INGRESAR</button>
            </form>
        </div>

        <!-- DASHBOARD -->
        <div id="dashboard" class="card" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>üìä Monitoreo en Tiempo Real</h2>
                <button onclick="logout()" style="padding: 8px 16px; background: #e53e3e; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    üö™ Cerrar Sesi√≥n
                </button>
            </div>
            
            <div class="status online" id="connectionStatus">Conectando...</div>
            <div class="data-grid" id="sensorData"></div>
            
            <h2>üéõÔ∏è Control de Bomba</h2>
            <div class="button-group">
                <button class="button on" onclick="controlBomba('on')">üü¢ ENCENDER</button>
                <button class="button off" onclick="controlBomba('off')">üî¥ APAGAR</button>
                <button class="button auto" onclick="controlBomba('auto')">‚öôÔ∏è AUTOM√ÅTICO</button>
            </div>
            <div class="status" id="bombaStatus">Estado: Cargando...</div>
            
            <div class="info-box" id="userInfo"></div>
        </div>
    </div>

    <script>
        let ESP32_BASE_URL = 'http://192.168.1.135';
        let usuarioActual = null;

        // CONFIGURACI√ìN
        document.getElementById('esp32IP').addEventListener('change', function() {
            ESP32_BASE_URL = 'http://' + this.value;
        });

        async function probarConexion() {
            const ip = document.getElementById('esp32IP').value;
            ESP32_BASE_URL = 'http://' + ip;
            
            try {
                const response = await fetch(`${ESP32_BASE_URL}/data`);
                document.getElementById('configStatus').textContent = '‚úÖ Conexi√≥n exitosa';
                document.getElementById('configStatus').className = 'status online';
            } catch (error) {
                document.getElementById('configStatus').textContent = '‚ùå Error de conexi√≥n - Verifica la IP';
                document.getElementById('configStatus').className = 'status offline';
            }
        }

        // LOGIN
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${ESP32_BASE_URL}/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `username=${username}&password=${password}`
                });
                const data = await response.json();
                
                if (data.success) {
                    usuarioActual = data;
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    document.getElementById('userInfo').innerHTML = `üë§ ${data.nombre} | ${data.esAdmin ? 'Administrador' : 'Estudiante'}`;
                    iniciarActualizacion();
                } else {
                    document.getElementById('errorMessage').textContent = data.message;
                    document.getElementById('errorMessage').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('errorMessage').textContent = 'Error de conexi√≥n al ESP32';
                document.getElementById('errorMessage').style.display = 'block';
            }
        });

        // ACTUALIZAR DATOS
        async function actualizarDatos() {
            try {
                const response = await fetch(`${ESP32_BASE_URL}/data`);
                const data = await response.json();
                
                document.getElementById('sensorData').innerHTML = `
                    <div class="data-item"><div class="data-value">${data.temperatura}¬∞C</div><div class="data-label">üå°Ô∏è Temperatura</div></div>
                    <div class="data-item"><div class="data-value">${data.humedad}%</div><div class="data-label">üíß Humedad</div></div>
                    <div class="data-item"><div class="data-value">${data.tds}</div><div class="data-label">üß™ TDS</div></div>
                    <div class="data-item"><div class="data-value">${data.phConectado ? data.ph.toFixed(1) : 'N/C'}</div><div class="data-label">üìä pH</div></div>
                    <div class="data-item"><div class="data-value">${data.bomba ? 'üü¢ ON' : 'üî¥ OFF'}</div><div class="data-label">üí¶ Bomba</div></div>
                    <div class="data-item"><div class="data-value">${data.modo}</div><div class="data-label">‚öôÔ∏è Modo</div></div>
                `;
                
                document.getElementById('bombaStatus').textContent = `Bomba: ${data.bomba ? 'ENCENDIDA' : 'APAGADA'} | Modo: ${data.modo}`;
                document.getElementById('connectionStatus').textContent = '‚úÖ CONECTADO';
                document.getElementById('connectionStatus').className = 'status online';
            } catch (error) {
                document.getElementById('connectionStatus').textContent = '‚ùå ERROR DE CONEXI√ìN';
                document.getElementById('connectionStatus').className = 'status offline';
            }
        }

        function iniciarActualizacion() {
            setInterval(actualizarDatos, 2000);
            actualizarDatos();
        }

        // CONTROL BOMBA
        async function controlBomba(accion) {
            if (!usuarioActual?.puedeControlarBomba) {
                alert('No tienes permisos para controlar la bomba');
                return;
            }
            try {
                await fetch(`${ESP32_BASE_URL}/bomba`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `estado=${accion}`
                });
                actualizarDatos();
            } catch (error) {
                alert('Error controlando bomba');
            }
        }

        // LOGOUT
        async function logout() {
            try {
                await fetch(`${ESP32_BASE_URL}/logout`);
            } catch (error) {}
            location.reload();
        }

        // INICIALIZAR
        probarConexion();
    </script>
</body>
</html>
